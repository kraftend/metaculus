# =============================================================================
# PR Preview Environment Workflow
# =============================================================================
#
# This workflow creates ephemeral preview environments for pull requests:
# 1. Builds Docker image and pushes to GitHub Container Registry (ghcr.io)
# 2. Creates a NeonDB database branch for isolated PostgreSQL
# 3. Creates a Redis database via Fly.io CLI (managed Upstash) for isolated caching
# 4. Deploys the preview app to Fly.io
# 5. Cleans up resources when PR is closed
#
# SECURITY:
# ---------
# - Internal PRs (from the same repo): Deploy automatically
# - Fork PRs (external contributors): Require "preview" label from maintainer
#
# This prevents external contributors from:
# - Accessing repository secrets
# - Deploying potentially malicious code
# - Consuming cloud resources without approval
#
# Required Secrets:
# -----------------
# - NEON_PROJECT_ID: Your Neon project ID (found in Neon Console project settings)
# - NEON_API_KEY: API key from Neon Console (https://console.neon.tech/app/settings/api-keys)
# - FLY_API_TOKEN: API token from Fly.io (run `fly tokens create deploy`)
# - FLY_PREVIEW_SECRETS: Multi-line secret containing all app secrets in KEY=value format
#     Example:
#       SECRET_KEY=django-secret-key-here
#       OPENAI_API_KEY=sk-xxx
#       SENTRY_DSN=https://xxx@sentry.io/xxx
#       MAILGUN_API_KEY=xxx
#
# Optional Variables:
# -------------------
# - FLY_ORG: Fly.io organization (defaults to 'personal')
# - FLY_REDIS_REGION: Redis region for Fly.io managed Upstash (defaults to 'iad')
# =============================================================================

name: PR Preview Environment

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - labeled
      - unlabeled
      - closed

concurrency:
  group: pr-preview-${{ github.event.number }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  pull-requests: write
  deployments: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  # Label required for fork PRs (security measure for external contributors)
  PREVIEW_LABEL: "preview"

jobs:
  # ===========================================================================
  # Security Check - Determine if PR can proceed with deployment
  # ===========================================================================
  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    outputs:
      # PR is approved if: (1) it's NOT from a fork, OR (2) it has the preview label
      is_approved: ${{ steps.evaluate.outputs.is_approved }}
      is_fork: ${{ steps.check_fork.outputs.is_fork }}
      has_label: ${{ steps.check_label.outputs.has_label }}
    steps:
      - name: Check if PR is from a fork
        id: check_fork
        run: |
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è This PR is from a fork: ${{ github.event.pull_request.head.repo.full_name }}"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
            echo "‚úÖ This PR is from the same repository"
          fi

      - name: Check for preview label
        id: check_label
        run: |
          HAS_LABEL="${{ contains(github.event.pull_request.labels.*.name, env.PREVIEW_LABEL) }}"
          echo "has_label=${HAS_LABEL}" >> $GITHUB_OUTPUT
          if [ "${HAS_LABEL}" == "true" ]; then
            echo "‚úÖ PR has the '${{ env.PREVIEW_LABEL }}' label"
          else
            echo "‚ÑπÔ∏è PR does not have the '${{ env.PREVIEW_LABEL }}' label"
          fi

      - name: Evaluate approval status
        id: evaluate
        run: |
          IS_FORK="${{ steps.check_fork.outputs.is_fork }}"
          HAS_LABEL="${{ steps.check_label.outputs.has_label }}"
          
          # Approved if: NOT a fork, OR has the preview label
          if [ "${IS_FORK}" == "false" ] || [ "${HAS_LABEL}" == "true" ]; then
            echo "is_approved=true" >> $GITHUB_OUTPUT
            echo "‚úÖ PR is approved for preview deployment"
          else
            echo "is_approved=false" >> $GITHUB_OUTPUT
            echo "‚è∏Ô∏è Fork PR requires '${{ env.PREVIEW_LABEL }}' label from maintainer"
          fi

      - name: Post guidance comment for fork PRs without label
        if: |
          github.event.action != 'closed' &&
          github.event.action != 'unlabeled' &&
          steps.check_fork.outputs.is_fork == 'true' &&
          steps.check_label.outputs.has_label != 'true'
        uses: peter-evans/find-comment@v3
        id: find_guidance
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '‚è∏Ô∏è Preview Environment Pending'

      - name: Create guidance comment for fork PRs
        if: |
          github.event.action != 'closed' &&
          github.event.action != 'unlabeled' &&
          steps.check_fork.outputs.is_fork == 'true' &&
          steps.check_label.outputs.has_label != 'true' &&
          steps.find_guidance.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ## ‚è∏Ô∏è Preview Environment Pending

            This PR is from a fork and requires the **`${{ env.PREVIEW_LABEL }}`** label to trigger a preview deployment.

            **Why?** For security, preview environments for fork PRs are only created after a maintainer reviews and approves the code.

            ---
            <details>
            <summary>For Maintainers</summary>

            To deploy a preview environment for this fork PR:
            1. Review the PR changes for security concerns
            2. Add the `${{ env.PREVIEW_LABEL }}` label to trigger the deployment
            3. The preview will be automatically destroyed when the PR is closed

            </details>

  # ===========================================================================
  # Setup Job - Get branch name and PR info
  # ===========================================================================
  setup:
    name: Setup
    needs: security-check
    if: |
      needs.security-check.outputs.is_approved == 'true' ||
      github.event.action == 'closed'
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.branch_name.outputs.current_branch }}
      short_sha: ${{ steps.short_sha.outputs.sha }}
      image_tag: ${{ steps.image_tag.outputs.tag }}
    steps:
      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

      - name: Get short SHA
        id: short_sha
        run: echo "sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Generate image tag
        id: image_tag
        run: echo "tag=pr-${{ github.event.number }}-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  # ===========================================================================
  # Build Docker Image - Build and push to GitHub Container Registry
  # ===========================================================================
  build-image:
    name: Build Docker Image
    needs: [security-check, setup]
    if: |
      github.event.action != 'closed' &&
      needs.security-check.outputs.is_approved == 'true'
    runs-on: ubuntu-24.04
    outputs:
      image_url: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Mutable tag - always points to latest build for this PR
            type=raw,value=pr-${{ github.event.number }}
            # Immutable tag - unique per commit (for rollbacks/debugging)
            type=raw,value=${{ needs.setup.outputs.image_tag }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          target: all_runners
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # ===========================================================================
  # Deploy to Fly.io - Deploy preview app with the built image
  # ===========================================================================
  deploy-preview:
    name: Deploy Preview App
    needs: [security-check, setup, build-image]
    if: |
      github.event.action != 'closed' &&
      needs.security-check.outputs.is_approved == 'true'
    runs-on: ubuntu-latest
    environment:
      name: Preview
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      app_name: ${{ steps.app_name.outputs.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate app name
        id: app_name
        run: |
          # Fly.io app names must be lowercase, alphanumeric with hyphens
          # Max 63 characters
          APP_NAME="metaculus-pr-${{ github.event.number }}"
          echo "name=${APP_NAME}" >> $GITHUB_OUTPUT
          echo "App name: ${APP_NAME}"

      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create NeonDB Branch
        id: neon
        uses: neondatabase/create-branch-action@v5
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          branch_name: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}
          username: neondb_owner

      - name: Create or Get Fly Redis Database
        id: redis
        run: |
          REDIS_NAME="preview-pr-${{ github.event.number }}"
          FLY_ORG="${{ vars.FLY_ORG || 'personal' }}"
          REDIS_REGION="${{ vars.FLY_REDIS_REGION || 'iad' }}"
          
          # Check if database already exists
          if flyctl redis list -o "${FLY_ORG}" | grep -q "${REDIS_NAME}"; then
            echo "‚úÖ Found existing Redis database: ${REDIS_NAME}"
          else
            echo "Creating new Redis database: ${REDIS_NAME}"
            flyctl redis create \
              --name "${REDIS_NAME}" \
              --region "${REDIS_REGION}" \
              --no-replicas \
              -o "${FLY_ORG}"
            echo "‚úÖ Created new Redis database: ${REDIS_NAME}"
          fi
          
          # Get Redis connection URL from status
          REDIS_STATUS=$(flyctl redis status "${REDIS_NAME}" -o "${FLY_ORG}" --json)
          REDIS_URL=$(echo "$REDIS_STATUS" | jq -r '.private_url // .privateUrl // .url')
          
          if [ -z "$REDIS_URL" ] || [ "$REDIS_URL" == "null" ]; then
            echo "‚ùå Failed to get Redis URL from status"
            echo "Status output: $REDIS_STATUS"
            exit 1
          fi
          
          # Set outputs
          echo "redis_cache_url=${REDIS_URL}" >> $GITHUB_OUTPUT
          echo "redis_mq_url=${REDIS_URL}" >> $GITHUB_OUTPUT
          echo "Redis URL retrieved successfully"

      - name: Create or update Fly app
        id: deploy
        run: |
          # Check if app exists, create if not
          if ! flyctl apps list | grep -q "${{ steps.app_name.outputs.name }}"; then
            echo "Creating new Fly app: ${{ steps.app_name.outputs.name }}"
            flyctl apps create ${{ steps.app_name.outputs.name }} \
              --org ${{ vars.FLY_ORG || 'personal' }}
          fi

          # Define app URLs (used for secrets and outputs)
          APP_DOMAIN="${{ steps.app_name.outputs.name }}.fly.dev"
          PUBLIC_APP_URL="https://${APP_DOMAIN}"

          # Set secrets for the app (these are encrypted at rest)
          # Dynamic secrets (generated per-PR) are set individually
          # Static secrets are imported from FLY_PREVIEW_SECRETS (one multi-line GitHub secret)
          
          # Import static secrets from GitHub secret (KEY=value format, one per line)
          echo "${{ secrets.FLY_PREVIEW_SECRETS }}" | flyctl secrets import \
            --app ${{ steps.app_name.outputs.name }} \
            --stage
          
          # Set dynamic secrets (unique per PR - URLs and database connections)
          flyctl secrets set \
            DATABASE_URL="${{ steps.neon.outputs.db_url_with_pooler }}" \
            REDIS_CACHE_URL="${{ steps.redis.outputs.redis_cache_url }}" \
            REDIS_MQ_URL="${{ steps.redis.outputs.redis_mq_url }}" \
            APP_DOMAIN="${APP_DOMAIN}" \
            PUBLIC_APP_URL="${PUBLIC_APP_URL}" \
            --app ${{ steps.app_name.outputs.name }} \
            --stage

          # Deploy using the pre-built image
          # VM memory/cpu settings are defined per-process in fly.toml
          flyctl deploy \
            --app ${{ steps.app_name.outputs.name }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }} \
            --ha=false \
            --now

          # Scale processes based on PR labels
          # By default, only run app process in previews (worker/cron are expensive and rarely needed)
          WORKER_COUNT=0
          CRON_COUNT=0
          
          # Check for preview-worker label
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'preview-worker') }}" == "true" ]]; then
            WORKER_COUNT=1
            echo "üì¶ preview-worker label detected - scaling worker to 1"
          fi
          
          # Check for preview-cron label
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'preview-cron') }}" == "true" ]]; then
            CRON_COUNT=1
            echo "‚è∞ preview-cron label detected - scaling cron to 1"
          fi
          
          echo "Scaling processes: app=1, worker=${WORKER_COUNT}, cron=${CRON_COUNT}"
          flyctl scale count app=1 worker=${WORKER_COUNT} cron=${CRON_COUNT} \
            --app ${{ steps.app_name.outputs.name }} \
            --yes

          # Output the app URL for other jobs
          echo "url=${PUBLIC_APP_URL}" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployed to: ${PUBLIC_APP_URL}"

  # ===========================================================================
  # Post Deployment Comment - Add comment to PR with preview URLs
  # ===========================================================================
  comment-on-pr:
    name: Comment on PR
    needs: [security-check, setup, deploy-preview]
    if: |
      github.event.action != 'closed' &&
      needs.security-check.outputs.is_approved == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Preview Environment'

      - name: Determine process status
        id: process_status
        run: |
          # Check labels for worker/cron
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'preview-worker') }}" == "true" ]]; then
            echo "worker=‚úÖ Running" >> $GITHUB_OUTPUT
          else
            echo "worker=‚è∏Ô∏è Scaled to 0" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'preview-cron') }}" == "true" ]]; then
            echo "cron=‚úÖ Running" >> $GITHUB_OUTPUT
          else
            echo "cron=‚è∏Ô∏è Scaled to 0" >> $GITHUB_OUTPUT
          fi

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.number }}
          edit-mode: replace
          body: |
            ## üöÄ Preview Environment

            Your preview environment is ready!

            | Resource | Details |
            |----------|---------|
            | üåê **Preview App** | ${{ needs.deploy-preview.outputs.url }} |
            | üì¶ **Docker Image** | `${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.image_tag }}` |
            | üóÑÔ∏è **PostgreSQL** | NeonDB branch `preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}` |
            | ‚ö° **Redis** | Fly Redis `preview-pr-${{ github.event.number }}` |

            ### Processes
            | Process | Status |
            |---------|--------|
            | üåê **app** (web server) | ‚úÖ Running |
            | üì¶ **worker** (background jobs) | ${{ steps.process_status.outputs.worker }} |
            | ‚è∞ **cron** (scheduled tasks) | ${{ steps.process_status.outputs.cron }} |

            ### Details
            - **Commit:** ${{ github.sha }}
            - **Branch:** `${{ needs.setup.outputs.branch }}`
            - **Fly App:** `${{ needs.deploy-preview.outputs.app_name }}`

            ---
            <details>
            <summary>‚ÑπÔ∏è Preview Environment Info</summary>

            - The preview app will be automatically destroyed when this PR is closed
            - Both PostgreSQL and Redis are isolated from production data
            - Changes pushed to this PR will trigger a new deployment
            - To enable background workers, add the `preview-worker` label
            - To enable cron jobs, add the `preview-cron` label

            </details>

  # ===========================================================================
  # Cleanup - Delete preview resources when PR is closed
  # ===========================================================================
  cleanup-preview:
    name: Cleanup Preview Resources
    needs: setup
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Delete Fly app
        continue-on-error: true
        run: |
          APP_NAME="metaculus-pr-${{ github.event.number }}"
          echo "Deleting Fly app: ${APP_NAME}"
          flyctl apps destroy ${APP_NAME} --yes || echo "App may not exist or already deleted"

      - name: Delete Neon Branch
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          branch: preview/pr-${{ github.event.number }}-${{ needs.setup.outputs.branch }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete Fly Redis Database
        continue-on-error: true
        run: |
          REDIS_NAME="preview-pr-${{ github.event.number }}"
          FLY_ORG="${{ vars.FLY_ORG || 'personal' }}"
          
          if flyctl redis list -o "${FLY_ORG}" | grep -q "${REDIS_NAME}"; then
            echo "Deleting Fly Redis database: ${REDIS_NAME}"
            flyctl redis destroy "${REDIS_NAME}" -o "${FLY_ORG}" --confirm "${REDIS_NAME}"
            echo "‚úÖ Deleted Fly Redis database"
          else
            echo "‚ÑπÔ∏è Fly Redis database not found or already deleted"
          fi

      - name: Delete PR Deployments from Preview Environment
        continue-on-error: true
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: Preview
          onlyRemoveDeployments: true
          ref: refs/pull/${{ github.event.number }}/merge

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Preview Environment'

      - name: Update comment to show cleanup
        if: steps.find_comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## üßπ Preview Environment Cleaned Up

            The preview environment for this PR has been destroyed.

            | Resource | Status |
            |----------|--------|
            | üåê Preview App | ‚úÖ Deleted |
            | üóÑÔ∏è PostgreSQL Branch | ‚úÖ Deleted |
            | ‚ö° Redis Database | ‚úÖ Deleted |
            | üîß GitHub Deployments | ‚úÖ Removed |
            | üì¶ Docker Image | ‚ö†Ô∏è Retained (auto-cleanup via GHCR policies) |

            ---
            *Cleanup triggered by PR close at ${{ github.event.pull_request.closed_at || 'N/A' }}*

  # ===========================================================================
  # Handle Label Removal - Cleanup if preview label is removed from fork PR
  # ===========================================================================
  handle-label-removal:
    name: Handle Label Removal
    needs: security-check
    if: |
      github.event.action == 'unlabeled' &&
      github.event.label.name == 'preview' &&
      needs.security-check.outputs.is_fork == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Get branch name
        id: branch_name
        uses: tj-actions/branch-names@v8

      - name: Delete Fly app
        continue-on-error: true
        run: |
          APP_NAME="metaculus-pr-${{ github.event.number }}"
          echo "Label removed from fork PR - Deleting Fly app: ${APP_NAME}"
          flyctl apps destroy ${APP_NAME} --yes || echo "App may not exist or already deleted"

      - name: Delete Neon Branch
        continue-on-error: true
        uses: neondatabase/delete-branch-action@v3
        with:
          project_id: ${{ secrets.NEON_PROJECT_ID }}
          branch: preview/pr-${{ github.event.number }}-${{ steps.branch_name.outputs.current_branch }}
          api_key: ${{ secrets.NEON_API_KEY }}

      - name: Delete Fly Redis Database
        continue-on-error: true
        run: |
          REDIS_NAME="preview-pr-${{ github.event.number }}"
          FLY_ORG="${{ vars.FLY_ORG || 'personal' }}"
          
          if flyctl redis list -o "${FLY_ORG}" | grep -q "${REDIS_NAME}"; then
            echo "Deleting Fly Redis database: ${REDIS_NAME}"
            flyctl redis destroy "${REDIS_NAME}" -o "${FLY_ORG}" --confirm "${REDIS_NAME}"
            echo "‚úÖ Deleted Fly Redis database"
          else
            echo "‚ÑπÔ∏è Fly Redis database not found or already deleted"
          fi

      - name: Delete PR Deployments from Preview Environment
        continue-on-error: true
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: Preview
          onlyRemoveDeployments: true
          ref: refs/pull/${{ github.event.number }}/merge

      - name: Find existing comment
        uses: peter-evans/find-comment@v3
        id: find_comment
        with:
          issue-number: ${{ github.event.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Preview Environment'

      - name: Update comment
        if: steps.find_comment.outputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            ## ‚èπÔ∏è Preview Environment Removed

            The `preview` label was removed from this fork PR, so the preview environment has been destroyed.

            To redeploy, a maintainer can add the `preview` label again.
